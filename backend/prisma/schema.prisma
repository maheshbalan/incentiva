// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String?
  firstName     String?
  lastName      String?
  role          UserRole @default(PARTICIPANT)
  oauthProvider String?
  oauthId       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  campaigns     UserCampaign[]
  redemptions   CampaignRedemption[]
  createdCampaigns Campaign[] @relation("CampaignCreator")

  @@map("users")
}

model Campaign {
  id                      String   @id @default(cuid())
  name                    String
  description             String?
  startDate               DateTime
  endDate                 DateTime
  status                  CampaignStatus @default(DRAFT)
  
  // Campaign Goals
  individualGoal          Decimal? @db.Decimal(15, 2)
  individualGoalCurrency  String   @default("MXN") // MXN, USD, EUR, etc.
  overallGoal             Decimal? @db.Decimal(15, 2)
  overallGoalCurrency     String   @default("MXN")
  totalPointsMinted       Decimal? @db.Decimal(15, 2) // Total points minted for the campaign
  
  // TLP Configuration
  tlpApiKey               String?
  tlpEndpointUrl          String?
  backendConnectionConfig  Json?
  
  // Campaign Rules
  eligibilityCriteria     String? // Natural language eligibility description
  
  createdById             String
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  createdBy               User     @relation("CampaignCreator", fields: [createdById], references: [id])
  rules                   CampaignRule[]
  executions              CampaignExecution[]
  schemas                 CampaignSchema[]
  userCampaigns           UserCampaign[]
  redemptions             CampaignRedemption[]
  goals                   CampaignGoal[]
  transactions            CampaignTransaction[]
  rulesEngineJobs        RulesEngineJob[]
  rulesEngineExecutions  RulesEngineExecution[]

  @@map("campaigns")
}

model CampaignGoal {
  id              String   @id @default(cuid())
  campaignId      String
  goalType        GoalType
  targetValue     Decimal  @db.Decimal(15, 2)
  currency        String   @default("MXN")
  description     String?
  isAchieved      Boolean  @default(false)
  achievedAt      DateTime?
  createdAt       DateTime @default(now())

  // Relations
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("campaign_goals")
}

model CampaignRule {
  id                      String   @id @default(cuid())
  campaignId              String
  ruleType                RuleType
  ruleDefinition          Json
  generatedCode           String?
  schemaUnderstandingScore Decimal? @db.Decimal(3, 2)
  schemaFeedback          String?
  createdAt               DateTime @default(now())

  // Relations
  campaign                Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("campaign_rules")
}

model CampaignExecution {
  id              String   @id @default(cuid())
  campaignId      String
  salespersonId   String?
  regionId        String?
  pointsAllocated Int      @default(0)
  goalAchieved    Boolean  @default(false)
  executionDate   DateTime @default(now())
  
  // Execution details
  transactionAmount Decimal? @db.Decimal(15, 2)
  transactionCurrency String? @default("MXN")
  transactionType   String? // "ACCRUAL" or "REDEMPTION"

  // Relations
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("campaign_executions")
}

model CampaignSchema {
  id                String   @id @default(cuid())
  campaignId        String
  schemaDefinition  Json
  understandingScore Decimal? @db.Decimal(3, 2)
  feedbackText      String?
  uploadedAt        DateTime @default(now())

  // Relations
  campaign          Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("campaign_schemas")
}

model UserCampaign {
  id              String   @id @default(cuid())
  userId          String
  campaignId      String
  participantId   String? // TLP member ID
  currentPoints   Int      @default(0)
  goalProgress    Decimal  @default(0) @db.Decimal(5, 2) // Percentage
  isEnrolled      Boolean  @default(true)
  enrolledAt      DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([userId, campaignId])
  @@map("user_campaigns")
}

model CampaignRedemption {
  id              String   @id @default(cuid())
  campaignId      String
  userId          String
  offerId         String // TLP offer ID
  offerName       String?
  offerDescription String?
  pointsRedeemed  Int
  redemptionDate  DateTime @default(now())
  status          RedemptionStatus @default(PENDING)
  
  // Redemption details
  tlpTransactionId String? // TLP transaction reference

  // Relations
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("campaign_redemptions")
}

model CampaignTransaction {
  id              String   @id @default(cuid())
  campaignId      String
  externalId      String? // Original invoice/order ID from customer system
  externalType    String? // "INVOICE", "ORDER", etc.
  
  // Transaction data (JSON structure from customer system)
  transactionData Json     // Raw transaction data from customer database
  processedData   Json?    // Processed/transformed data after rules application
  
  // Rules engine processing
  rulesApplied    Boolean  @default(false)
  pointsAllocated Int      @default(0)
  processingStatus TransactionProcessingStatus @default(PENDING)
  
  // TLP integration
  tlpAccrualPayload Json? // TLP API request payload
  tlpTransactionId String? // TLP transaction reference
  tlpResponse      Json?   // TLP API response
  
  // Processing metadata
  processedAt     DateTime?
  errorMessage    String?
  retryCount      Int      @default(0)
  maxRetries      Int      @default(3)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("campaign_transactions")
}

model RulesEngineJob {
  id              String   @id @default(cuid())
  campaignId      String
  jobType         RulesEngineJobType
  status          RulesEngineJobStatus @default(PENDING)
  
  // Job configuration
  schedule        String?  // Cron expression for recurring jobs
  isRecurring     Boolean  @default(false)
  lastRunAt       DateTime?
  nextRunAt       DateTime?
  
  // Data source configuration
  dataSourceConfig Json    // Database connection and query configuration
  
  // Processing configuration
  batchSize       Int      @default(1000)
  maxConcurrency  Int      @default(5)
  
  // Execution tracking
  totalRecords    Int      @default(0)
  processedRecords Int     @default(0)
  failedRecords   Int      @default(0)
  
  // Job metadata
  startedAt       DateTime?
  completedAt     DateTime?
  errorMessage    String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  executions     RulesEngineExecution[]

  @@map("rules_engine_jobs")
}

model RulesEngineExecution {
  id              String   @id @default(cuid())
  jobId           String
  campaignId      String
  
  // Execution details
  executionType   RulesEngineExecutionType
  status          RulesEngineExecutionStatus @default(RUNNING)
  
  // Data processing
  recordsProcessed Int     @default(0)
  recordsSucceeded Int     @default(0)
  recordsFailed    Int     @default(0)
  
  // Performance metrics
  startTime       DateTime @default(now())
  endTime         DateTime?
  durationMs      Int?
  
  // Error handling
  errorMessage    String?
  stackTrace      String?
  
  // Logs and metadata
  executionLog    Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  job            RulesEngineJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  campaign       Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("rules_engine_executions")
}

model SystemConfiguration {
  id              String   @id @default(cuid())
  key             String   @unique
  value           String
  description     String?
  updatedAt       DateTime @updatedAt
  updatedBy       String?

  @@map("system_configurations")
}

model AIConfiguration {
  id              String   @id @default(cuid())
  provider        AIProvider
  modelName       String
  apiKey          String
  isActive        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("ai_configurations")
}

// Enums
enum UserRole {
  ADMIN
  PARTICIPANT
}

enum CampaignStatus {
  DRAFT
  APPROVED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum RuleType {
  GOAL
  ELIGIBILITY
  PRIZE
}

enum RedemptionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum GoalType {
  INDIVIDUAL
  OVERALL
  REGIONAL
}

enum AIProvider {
  ANTHROPIC
  OPENAI
  GOOGLE
  AZURE
}

enum TransactionProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRY
}

enum RulesEngineJobType {
  INITIAL_DATA_LOAD
  INCREMENTAL_UPDATE
  RULES_PROCESSING
  TLP_SYNC
}

enum RulesEngineJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  SCHEDULED
}

enum RulesEngineExecutionType {
  DATA_EXTRACTION
  RULES_APPLICATION
  TLP_INTEGRATION
  FULL_PROCESSING
}

enum RulesEngineExecutionStatus {
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
} 